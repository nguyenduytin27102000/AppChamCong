@model IEnumerable<TimeKeeping.Models.CheckinWithView>

@{
    ViewData["Title"] = "Index";

}
<link rel="stylesheet" type="text/css" href="~/css/CheckinIndex.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">



<img id="logo" src="~/icon/Logo.png" alt="Infodation">
<h1 class="text-center">Person Timesheet</h1>
<div class="form-group">
    <i class="fas fa-search icon" style="font-size:26px; "></i>
    <!--This is for "not found"" when model.count = 0, it mean not any data. Different if else is onkeyup="quickSearch()" -->
    @{
        if (Model.Count() == 0)
        {
            <input type="text" id="quickSearch" placeholder="Search for date.." title="Type in a date" class="form-control  mr-2">
        }
        else
        {
            <input type="text" id="quickSearch" onkeyup="quickSearch()" placeholder="Search for date.." title="Type in a date" class="form-control  mr-2">
        }
    }
</div>

<!--<p id="tsTime">Timesheet of @ViewBag.Month-@ViewBag.Year</p>-->
<table class="table  table-striped table-bordered" id="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Time)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Personnal)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.WorkScheduleName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.MinutesLate)
            </th>

            <th hidden>
                @Html.DisplayNameFor(model => model.Regulations)
            </th>
            <th hidden>
                @Html.DisplayNameFor(model => model.DayOff)
            </th>
            <th>
                Action
            </th>
        </tr>
    </thead>
    <tbody>
        @{
            var count = 0;
            double totalMinuteLates = 0;


            if (Model.Count() == 0)
            {
                <tr>
                    <td colspan="5" class="text-center"><strong>Not found</strong></td>
                </tr>
            }
            else
            {
                <tr style="display:none">
                    <td colspan="5" class="text-center"><strong>Not found</strong></td>
                </tr>
            }

        }
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Time)<br>
                    <strong id="dayofweek"> @item.Time.DayOfWeek</strong>
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Personnal)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.WorkScheduleName)
                </td>
                <!--we only need time so we format time -->
                @{
                    String tc = @item.Time.ToString("hh:mm tt");
                    String ts = @item.StartTime.ToString("hh:mm tt");
                    DateTime timeCheckin = DateTime.Parse(tc, System.Globalization.CultureInfo.CurrentCulture);
                    DateTime timeStart = DateTime.Parse(ts, System.Globalization.CultureInfo.CurrentCulture);
                    double minutesLate = (timeCheckin.Subtract(timeStart).TotalMinutes);
                    if (minutesLate > @item.MinutesLate)
                    {

                        <td>@minutesLate<i class="fas fa-clock"></i></td>
                        if (@item.DayOff != true)
                            totalMinuteLates = totalMinuteLates + minutesLate;
                    }
                    else
                    {
                        <td>0<i class="fas fa-check"></i></td>
                    }
                }

                <td hidden>
                    @Html.DisplayFor(modelItem => item.Regulations)
                </td>

                <td hidden>
                    @Html.DisplayFor(modelItem => item.DayOff)
                </td>

                <td>
                    <a class="btn bt"  asp-controller="FeedbackCheckin" asp-action="Feedback" asp-route-id="@item.CheckinId">Feedback</a>
                </td>
            </tr>
            if (@item.DayOff != true)
                count = count + 1;
        }
        <tr>
            <ul class="total">
                <li> Total shifts: <span id="totalShifts">@count </span> </li>
                <li> Total minutes late: <span id="totalMinutes"> @totalMinuteLates </span> </li>
            </ul>
        </tr>
    </tbody>
</table>
<script>
    function quickSearch() {
      var input, filter, table, tr, td, i, txtValue, count;
      count = 0;
      input = document.getElementById("quickSearch");
      filter = input.value.toUpperCase();
      table = document.getElementById("table");
      tr = table.getElementsByTagName("tr");
      for (i = 2; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[0];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
            count = count + 1;
          } else {
            tr[i].style.display = "none";
          }
        }
      }
      if(count>0)
      {
      tr[1].style.display = "none";
      } else {
           tr[1].style.display = "";
      }
      minuteTotal();
    }


    function minuteTotal() {
      var totalMinutes,totalShifts,td,tr,table;
      totalMinutes=0;
      totalShifts=0;
      table = document.getElementById("table");
      tr = table.getElementsByTagName("tr");
      for (i = 2; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[3];
        if(tr[i].style.display!="none"){
            if (td) {
                totalMinutes=totalMinutes + parseFloat(td.innerHTML);
                totalShifts = totalShifts + 1;
            }
        }
      }
      document.getElementById("totalMinutes").innerHTML = totalMinutes;
      document.getElementById("totalShifts").innerHTML = totalShifts;
    }

</script>